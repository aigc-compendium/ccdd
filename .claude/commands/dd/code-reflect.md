---
allowed-tools: Task
---

# 代码变更反思

使用 AI 智能体对 Git 未提交的文件变动进行深度反思分析，评估代码变更的合理性、质量和影响。

## 用法

```bash
/dd:code-reflect
[可选: 具体关注点描述]
```

## 执行方式

直接调用 `code-analyzer` 智能体进行代码变更反思分析。智能体将自动：

1. **检测代码变更** - 分析 Git 工作区和暂存区的变更
2. **识别项目类型** - 通过配置文件识别技术栈
3. **执行项目质检** - 运行项目相关的代码质量检查工具
4. **关联项目上下文** - 从 `.claude/context` 和 `.claude/features` 获取背景信息
5. **深度反思分析** - 评估变更的合理性、质量和影响

## 智能体分析

使用 Task 工具调用 code-analyzer 智能体：

```yaml
Task:
  description: '代码变更反思分析'
  subagent_type: 'code-analyzer'
  prompt: |
    请对当前的代码变更进行深度反思分析。请按以下步骤执行：

    ## 第一步：变更检测
    1. 检查是否有未提交的代码变更 (git diff, git diff --staged)
    2. 如果没有变更，提示用户并给出建议

    ## 第二步：项目环境识别
    1. 识别项目类型和技术栈 (package.json, requirements.txt 等)
    2. 确定可用的质检工具和命令
    3. 读取项目上下文信息 (.claude/context/, .claude/features/)

    ## 第三步：代码质检执行
    根据项目类型自动执行相关质检命令：
    - Node.js: npm run lint, npm run test, npm run typecheck
    - Python: flake8, pytest, mypy
    - Go: go fmt, go vet, go test
    - 其他项目类型的相应质检工具

    ## 第四步：深度反思分析
    分析维度包括：

    1. **变更合理性**
       - 变更目的和价值
       - 与当前议题的一致性
       - 变更范围的合理性

    2. **代码质量**
       - 编码规范遵循度
       - 可读性和维护性
       - 错误处理完备性

    3. **架构影响**
       - 对系统架构的影响
       - 模块耦合度
       - 技术债务风险

    4. **安全性**
       - 安全风险评估
       - 输入验证充分性
       - 敏感信息处理

    5. **性能影响**
       - 性能瓶颈风险
       - 资源使用优化

    ## 输出格式

    ```markdown
    # 🔍 代码变更反思分析

    ## 📊 变更概览
    - 修改文件：[数量和主要文件]
    - 代码行变更：[统计信息]
    - 变更类型：[功能类型]

    ## 🔍 质检结果
    [执行的质检命令及结果]

    ## 🎯 变更合理性：[评级]
    [具体分析]

    ## ⭐ 代码质量：[评级]
    [问题和建议]

    ## 🏗️ 架构影响：[评级]
    [影响分析]

    ## 🔒 安全评估：[评级]
    [安全分析]

    ## ⚡ 性能影响：[评级]
    [性能分析]

    ## 💡 改进建议
    [优先级排序的建议]

    ## 🎯 下一步行动
    [具体行动建议]
    ```

    约束条件：
    - 遵循 DD 系统绝对安全规则
    - 只进行分析，不执行任何文件修改
    - 不执行 git 写操作
    - 结合项目上下文提供针对性建议
```

## 使用说明

命令执行时将直接调用 `code-analyzer` 智能体，无需复杂的 shell 脚本。智能体会：

1. 自动检测和分析代码变更
2. 识别项目类型并执行相应的质检工具  
3. 结合项目上下文进行深度反思分析
4. 提供具体的改进建议和下一步行动

智能体具备完整的项目分析能力，可以提供比传统脚本更智能、更精准的代码反思分析。
