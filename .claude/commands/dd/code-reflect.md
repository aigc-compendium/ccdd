---
allowed-tools: Task, Bash, Read, Grep, Glob
---

# 代码变更反思

基于 Git 未提交的文件变动进行深度反思分析, 评估代码变更的合理性、质量和影响.

## 用法

```
/dd:code-reflect
[可选: 具体关注点描述]
```

## 执行流程

### 1. Git 变更检测

首先检测所有未提交的文件变更:

```bash
echo "🔍 检测代码变更..."

# 检查工作区变更
working_changes=$(git diff --name-only 2>/dev/null | wc -l)
staged_changes=$(git diff --staged --name-only 2>/dev/null | wc -l)

if [ "$working_changes" -eq 0 ] && [ "$staged_changes" -eq 0 ]; then
  echo "✅ 没有检测到未提交的代码变更"
  echo "💡 如需反思已提交的变更, 请指定提交范围: "
  echo "   git show <commit-hash>"
  exit 0
fi

echo "📊 变更概览: "
echo "  工作区变更: $working_changes 个文件"
echo "  暂存区变更: $staged_changes 个文件"
```

### 2. 变更文件分析

分析变更的文件类型和范围:

```bash
echo ""
echo "📝 变更文件列表: "
git diff --name-only HEAD 2>/dev/null | while read file; do
  if [ -f "$file" ]; then
    file_type=$(file "$file" | cut -d: -f2)
    echo "  📄 $file ($file_type)"
  fi
done
```

### 3. 深度代码分析

使用 Task 工具调用 general-purpose 智能体进行深度分析:

```yaml
Task:
  description: '代码变更深度分析'
  subagent_type: 'general-purpose'
  prompt: |
    请对以下代码变更进行深度反思分析: 

    变更概览: 
    工作区变更: $(git diff --stat 2>/dev/null)
    暂存区变更: $(git diff --staged --stat 2>/dev/null)

    具体变更内容: 
    $(git diff HEAD 2>/dev/null)

    项目上下文: 
    - 项目信息: $(cat .claude/context/project.md 2>/dev/null || echo "项目上下文未找到")
    - 技术栈: $(cat .claude/context/tech-stack.md 2>/dev/null || echo "技术栈信息未找到")
    - 架构信息: $(cat .claude/context/architecture.md 2>/dev/null || echo "架构信息未找到")

    深度分析维度: 

    1. **变更合理性分析**: 
       - 变更是否有明确的目的和价值？
       - 是否符合当前的开发任务或目标？
       - 变更范围是否适当, 没有过度修改？
       - 是否有不必要的或无关的修改？

    2. **代码质量评估**: 
       - 是否遵循项目的编码规范和风格？
       - 代码可读性和维护性如何？
       - 是否有适当的错误处理？
       - 变量和函数命名是否清晰？
       - 是否有代码重复或死代码？

    3. **架构影响分析**: 
       - 变更对系统架构的影响程度？
       - 是否破坏了现有的架构模式？
       - 模块间的耦合度是否合理？
       - 是否引入了新的技术债务？

    4. **安全性评估**: 
       - 是否引入了潜在的安全风险？
       - 输入验证和输出转义是否充分？
       - 是否正确处理了敏感信息？
       - 权限控制是否适当？

    5. **性能影响分析**: 
       - 变更对系统性能的潜在影响？
       - 是否引入了性能瓶颈？
       - 数据库查询和网络请求是否优化？
       - 内存使用是否合理？

    6. **边界情况评估**: 
       - 边界条件和异常情况是否考虑？
       - 错误处理是否完备？
       - 数据验证是否充分？

    输出要求: 
    请按照以下格式提供分析结果: 

    ## 🔍 代码变更反思分析

    ### 📊 变更概览
    - 修改文件: [数量和主要文件]
    - 代码行变更: [新增/修改/删除统计]
    - 变更类型: [功能新增/bug修复/重构/性能优化等]

    ### 🎯 变更合理性: [✅优秀/⚠️需要关注/❌有问题]
    [具体分析内容]

    ### ⭐ 代码质量: [✅优秀/⚠️需要改进/❌有问题]
    [具体问题和建议]

    ### 🏗️ 架构影响: [✅影响可控/⚠️需要评估/❌有风险]
    [架构影响分析]

    ### 🔒 安全评估: [✅安全合规/⚠️需要关注/❌有风险]
    [安全相关分析]

    ### ⚡ 性能影响: [✅性能良好/⚠️需要关注/❌有风险]
    [性能影响分析]

    ### 🔍 质量评估: [✅质量良好/⚠️需要改进/❌存在问题]
    [代码质量相关建议]

    ### 💡 改进建议
    [具体的改进建议, 按优先级排列]

    ### 🎯 下一步建议
    [建议的后续行动]

    重要约束: 
    - 严格遵循绝对安全规则
    - 只进行分析, 不执行任何修改操作
    - 不执行git操作
    - 提供客观、建设性的分析
    - 考虑项目的具体上下文和技术栈
```

### 4. 当前任务关联分析

如果存在当前执行的任务, 关联分析变更与任务的一致性:

```bash
# 查找当前活跃的任务
current_tasks=$(find .claude/features -name "*.md" -path "*/tasks/*" -exec grep -l "^status: 进行中" {} \; 2>/dev/null)

if [ -n "$current_tasks" ]; then
  echo ""
  echo "🎯 任务关联分析: "
  echo "发现进行中的任务, 将分析变更与任务目标的一致性"
fi
```

### 5. 历史变更模式分析

分析最近的提交模式, 识别开发趋势:

```bash
echo ""
echo "📈 最近开发模式: "
git log --oneline -10 2>/dev/null | head -5
```

### 6. 交互式改进建议

基于分析结果提供交互式建议:

```bash
echo ""
echo "🤔 基于反思分析, 您希望: "
echo "  1. 查看具体的改进建议详情"
echo "  2. 针对特定文件进行深入分析"
echo "  3. 生成变更说明和提交消息建议"
echo "  4. 继续当前开发工作"
echo ""
echo "💡 您也可以使用 /dd:chat 进行深入讨论"
```

## 分析重点

### 代码质量检查点

- **一致性** - 命名约定、代码风格、项目规范
- **可读性** - 代码清晰度、注释质量、逻辑结构
- **健壮性** - 错误处理、边界检查、异常处理
- **可维护性** - 模块化、耦合度、复用性

### 架构完整性

- **设计原则** - 是否遵循 SOLID 原则等设计原则
- **分层架构** - 是否正确使用分层架构
- **依赖管理** - 依赖注入、循环依赖检查
- **接口设计** - API 设计的一致性和合理性

### 安全最佳实践

- **输入验证** - 所有外部输入的验证和清理
- **输出编码** - 防止 XSS 和注入攻击
- **权限控制** - 访问控制和权限验证
- **敏感信息** - 密钥、密码等敏感信息的处理

## 输出格式示例

```markdown
🔍 代码变更反思分析

📊 变更概览:
修改文件: 3 个 (user.service.js, auth.controller.js, user.model.js)
代码行变更: +85/-23
变更类型: 功能增强 + 安全加固

🎯 变更合理性: ✅ 优秀
变更目标明确, 专注于用户认证功能的安全性提升

⭐ 代码质量: ⚠️ 需要改进
发现的问题:
• user.service.js:45 - 缺少输入验证
• auth.controller.js:89 - 建议提取魔法数字为常量

🏗️ 架构影响: ✅ 影响可控
变更遵循现有分层架构, 未破坏模块边界

🔒 安全评估: ✅ 安全合规
正确实现了密码哈希和 JWT 处理

⚡ 性能影响: ✅ 性能良好
查询优化合理, 未引入性能瓶颈

🧪 测试建议: ⚠️ 需要补充
建议为新增的安全功能添加单元测试

💡 改进建议:

1. 添加输入验证中间件
2. 提取常量到配置文件
3. 增加错误处理的单元测试
4. 考虑添加 API 速率限制

🎯 下一步建议:
• 修复代码质量问题
• 运行现有测试套件
• 添加安全相关测试
• 考虑代码审查后再提交
```

## 深度思考要点

1. **批判性分析** - 客观评估变更的必要性和合理性
2. **质量标准** - 对照项目标准和最佳实践
3. **影响评估** - 全面考虑对系统各方面的影响
4. **改进导向** - 提供具体可行的改进建议
5. **上下文感知** - 结合项目具体情况分析

## 安全约束

严格遵循 DD 系统规则:

1. **只读分析** - 不执行任何文件修改操作
2. **Git 安全** - 不执行任何 git 写操作
3. **客观评估** - 提供客观、建设性的分析
4. **上下文保护** - 不暴露敏感信息或凭证
