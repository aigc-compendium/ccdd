---
allowed-tools: Read, Write, LS, Task
---

# 更新项目上下文

更新 `.claude/context/` 中的项目上下文文档以反映项目的当前状态。在每个开发会话结束时运行此命令保持上下文准确。

## 用法
```
/dd:context-update
```

## 预检清单

执行前完成这些验证步骤。
不要打扰用户预检进度，直接执行并继续。

### 1. 上下文验证
- 运行：`ls -la .claude/context/ 2>/dev/null`
- 如果目录不存在或为空：
  - 告诉用户："❌ 没有上下文需要更新。请先运行 /dd:context-create。"
  - 优雅退出
- 统计现有文件：`ls -1 .claude/context/*.md 2>/dev/null | wc -l`
- 报告："📁 发现 {count} 个上下文文件需要检查更新"

### 2. 变更检测

收集变更信息：

**Git 变更：**
```bash
git status --short  # 查看未提交的变更
git log --oneline -10  # 查看最近提交
git diff --stat HEAD~5..HEAD 2>/dev/null  # 查看最近变更的文件
```

**文件修改：**
```bash
find .claude/context -name "*.md" -type f -exec ls -lt {} + | head -5  # 检查上下文文件年龄
# 注意哪些上下文文件最旧，可能需要更新
```

**依赖变更：**
```bash
git diff HEAD~5..HEAD package.json 2>/dev/null  # Node.js
git diff HEAD~5..HEAD requirements.txt 2>/dev/null  # Python
# 检查是否添加了新依赖或版本变更
```

### 3. 获取当前时间
- 运行：`date -u +"%Y-%m-%dT%H:%M:%SZ"`
- 在修改文件的 `最后更新` 字段中使用

## 操作指南

### 1. 系统化变更分析

对每个上下文文件，确定是否需要更新：

#### `progress.md` - **始终更新**
- 检查：最近提交、当前分支、未提交变更
- 更新：最新完成工作、当前阻碍、下一步行动
- 运行：`git log --oneline -5` 获取最近提交消息
- 如果适用，包含完成百分比

#### `project-structure.md` - **结构变更时更新**
- 检查：`git diff --name-status HEAD~10..HEAD | grep -E '^A'` 查找新文件
- 更新：新目录、移动文件、结构重组
- 只在发生重要结构变更时更新

#### `tech-context.md` - **依赖变更时更新**
- 检查：包文件中的新依赖或版本变更
- 更新：新库、升级版本、新开发工具
- 包含安全更新或破坏性变更

#### `system-patterns.md` - **架构变更时更新**
- 检查：新设计模式、架构决策
- 更新：采用的新模式、完成的重构
- 只在重要架构变更时更新

#### `product-context.md` - **需求变更时更新**
- 检查：实施的新功能、纳入的用户反馈
- 更新：新用户故事、变更需求
- 包含产品方向的任何转向

#### `project-brief.md` - **很少更新**
- 检查：只在基本项目目标变更时
- 更新：重大范围变更、新目标
- 通常保持稳定

#### `project-overview.md` - **重大里程碑时更新**
- 检查：完成的主要功能、重要进展
- 更新：功能状态、能力变更
- 达到项目里程碑时更新

#### `project-vision.md` - **很少更新**
- 检查：战略方向变更
- 更新：只在重大愿景转变时
- 通常保持稳定

#### `project-style-guide.md` - **惯例变更时更新**
- 检查：新 linting 规则、风格决策
- 更新：惯例变更、采用的新模式
- 包含新模式的示例

### 2. 智能更新策略

**对每个需要更新的文件：**

1. **读取现有文件** 理解当前内容
2. **识别具体部分** 需要更新
3. **保留前置元数据** 但更新 `最后更新` 字段：
   ```yaml
   ---
   创建时间: [保留原始]
   最后更新: [使用 date 命令的真实时间]
   版本: [重大更新时递增，如 1.0 → 1.1]
   作者: DD 工作流系统
   ---
   ```
4. **进行目标性更新** - 不要重写整个文件
5. **如有重要变更添加更新记录**：
   ```markdown
   ## 更新历史
   - {date}: {变更摘要}
   ```

### 3. 使用智能体进行复杂分析

对于大规模变更（>10个修改文件），使用 Task 工具：

```yaml
Task:
  description: "分析项目变更影响"
  subagent_type: "code-analyzer"
  prompt: |
    分析自上次上下文更新以来的项目变更：
    
    最近变更的文件：
    {列出最近修改的文件}
    
    最近提交：
    {列出最近5个提交}
    
    请识别：
    1. 架构或模式的重要变更
    2. 新增或更新的技术依赖
    3. 项目结构的变化
    4. 功能或产品方向的变化
    
    为需要更新的上下文文件提供具体的更新建议。
```

### 4. 更新验证

更新每个文件后：
- 验证文件仍有有效的前置元数据
- 检查文件大小合理（未损坏）
- 确保 markdown 格式保持正确
- 确认更新准确反映变更

### 5. 跳过优化

**跳过不需要更新的文件：**
- 如果没有检测到相关变更，跳过文件
- 在摘要中报告跳过的文件
- 如果内容未变更不要更新时间戳
- 这保持准确的"最后修改"信息

### 6. 错误处理

**常见问题：**
- **文件锁定：**"❌ 无法更新 {file} - 可能在编辑器中打开"
- **权限被拒：**"❌ 无法写入 {file} - 检查权限"
- **文件损坏：**"⚠️ {file} 似乎已损坏 - 跳过更新"
- **磁盘空间：**"❌ 磁盘空间不足，无法更新"

如果更新失败：
- 报告成功更新的文件
- 注明失败文件及原因
- 保留原始文件（不留下损坏状态）

### 7. 更新摘要

提供详细的更新摘要：

```markdown
🔄 上下文更新完成

📊 更新统计：
  - 扫描文件：{total_count}
  - 更新文件：{updated_count}
  - 跳过文件：{skipped_count}（无需变更）
  - 错误：{error_count}

📝 已更新文件：
  ✅ progress.md - 更新最近提交、当前状态
  ✅ tech-context.md - 添加 3 个新依赖
  ✅ project-structure.md - 标注新的 /utils 目录

⏭️ 跳过文件（无变更）：
  - project-brief.md（最后更新：5天前）
  - project-vision.md（最后更新：2周前）
  - system-patterns.md（最后更新：3天前）

⚠️ 问题：
  {任何警告或错误}

⏰ 最后更新：{timestamp}
🔄 下一步：定期运行此命令保持上下文当前
💡 提示：重大变更？考虑运行 /dd:context-create 进行完全刷新
```

### 8. 增量更新跟踪

**跟踪更新内容：**
- 注明每个文件的哪些部分被修改
- 保持变更专注和精准
- 不重新生成未变更内容
- 保留格式和结构

### 9. 性能优化

对于大项目：
- 可能时并行处理文件
- 显示进度："更新上下文文件... {current}/{total}"
- 跳过非常大的文件并警告
- 使用 git diff 快速识别变更区域

## 上下文收集命令

使用这些命令检测变更：
- 上下文目录：`.claude/context/`
- 当前 git 状态：`git status --short`
- 最近提交：`git log --oneline -10`
- 变更文件：`git diff --name-only HEAD~5..HEAD 2>/dev/null`
- 分支信息：`git branch --show-current`
- 未提交变更：`git diff --stat`
- 新的未跟踪文件：`git ls-files --others --exclude-standard | head -10`
- 依赖变更：检查 package.json、requirements.txt 等

## 重要说明

- **只更新有实际变更的文件** - 保持准确时间戳
- **始终使用真实时间** 从系统时钟更新 `最后更新`
- **进行精准更新** - 不要重新生成整个文件
- **验证每次更新** - 确保文件保持有效
- **提供详细摘要** - 显示变更和未变更内容
- **优雅处理错误** - 不要损坏现有上下文

## 安全约束

- 遵循 `.claude/rules/git-safety.md` 中的所有安全规则
- 只执行只读的 git 操作进行变更检测
- 不修改项目代码或配置文件
- 仅更新 `.claude/context/` 目录下的文件