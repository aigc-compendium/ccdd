---
allowed-tools: Task, Read, Write, Edit, MultiEdit, Bash
---

# DD 任务状态更新

智能更新任务状态、进度和相关信息，支持手动更新或基于代码变更自动推断。

## 核心功能

### 1. 任务状态读取

自动调用状态脚本获取当前任务信息：

```bash
bash .claude/scripts/dd/query/get-task.sh "<feature>:<task_id>"
```

### 2. 智能状态更新

基于以下信息智能判断并更新任务状态：

- **代码变更** - 分析 Git diff 和文件变更
- **TODO 完成度** - 统计任务文档中的 TODO 项目
- **测试状态** - 检查相关测试文件和结果
- **用户输入** - 接受用户手动指定的状态更新

### 3. 进度自动计算

- 基于 TODO 项目完成度计算进度
- 结合代码实现情况调整进度
- 更新任务文档的 progress 字段

## 状态更新逻辑

### 任务状态定义

- **未开始** (0%) - 任务尚未开始，无代码变更
- **进行中** (1%-99%) - 任务正在进行，有部分实现
- **已完成** (100%) - 任务完全完成，通过验收标准
- **需重构** - 任务需要重新设计或实现

### 自动状态推断规则

1. **检查 TODO 完成度**
   - 所有 TODO 项目完成 → 候选状态：已完成
   - 部分 TODO 完成 → 候选状态：进行中
   - 无 TODO 完成 → 保持当前状态

2. **分析代码变更**
   - 有相关文件创建/修改 → 状态：进行中或已完成
   - 无相关变更 → 状态：未开始或暂停

3. **验收标准检查**
   - 满足所有验收条件 → 状态：已完成
   - 部分满足 → 状态：进行中

## 使用方式

### 自动更新（推荐）

```bash
/dd:task-update <feature>:<task_id>
```

AI 会自动：
1. 读取当前任务状态
2. 分析代码变更和 TODO 完成情况
3. 智能推断新的状态和进度
4. 更新任务文档

### 手动指定状态

```bash
/dd:task-update <feature>:<task_id> --status "已完成" --progress 100
```

支持的参数：
- `--status` - 指定新状态
- `--progress` - 指定进度百分比
- `--notes` - 添加更新说明

## 执行流程

### 1. 状态信息收集

```bash
# 读取当前任务状态
bash .claude/scripts/dd/query/get-task.sh "<feature>:<task_id>"
```

### 2. 变更分析

- 检查 Git 工作区状态
- 分析相关文件的修改情况
- 统计 TODO 项目完成度
- 检查测试文件存在性

### 3. 智能状态推断

基于收集的信息，AI 智能判断：
- 任务的实际完成情况
- 合适的状态转换
- 准确的进度百分比

### 4. 文档更新

更新任务文档的元数据：
- `status` - 任务状态
- `progress` - 完成进度
- `updated_at` - 更新时间
- `notes` - 更新说明（如有）

### 5. 会话记录

更新任务的会话上下文文件 `context/session/<feature_name>/<task_id>.md`：
- 记录状态变更历史
- 保存工作进展摘要
- 记录重要决策和注意事项

## 输出示例

### 状态更新成功

```
=== TASK_UPDATE_COMPLETED ===
TASK_ID: 用户认证系统:001
TASK_NAME: 实现用户注册功能
STATUS_CHANGE: 进行中 → 已完成
PROGRESS_CHANGE: 75% → 100%
UPDATED_AT: 2024-01-15 14:30:00

📊 更新摘要:
  ✅ 所有 TODO 项目已完成 (5/5)
  ✅ 相关代码文件已实现
  ✅ 满足验收标准
  
💡 下一步建议:
  继续执行 用户认证系统:002 任务
```

### 智能推断状态

```
=== INTELLIGENT_STATUS_ANALYSIS ===
🔍 分析结果:
  • TODO 完成度: 3/5 (60%)
  • 代码变更: 4 个文件修改
  • 测试文件: 存在
  • 验收条件: 部分满足

📋 推荐更新:
  状态: 未开始 → 进行中
  进度: 0% → 60%
  
✅ 是否确认此更新? (自动应用)
```

## 批量更新

当需要更新功能的所有任务时，建议使用 `/dd:feature-update` 命令。

## 使用示例

```bash
# 自动更新任务状态
/dd:task-update 用户认证系统:001

# 手动指定完成状态
/dd:task-update 用户认证系统:001 --status "已完成" --progress 100
```

## 注意事项

- 状态更新后无法自动撤销，请谨慎操作
- 建议在重要节点及时更新任务状态
- 自动推断的状态可能需要人工确认
- 状态更新会影响功能整体进度计算