---
allowed-tools: Read, LS, Task
---

# 加载项目上下文

通过读取项目上下文文档并理解代码库结构，为新的智能体会话加载必要上下文。

## 用法
```
/dd:context-prime
```

## 预检清单

执行前完成这些验证步骤。
不要打扰用户预检进度，直接执行并继续。

### 1. 上下文可用性检查
- 运行：`ls -la .claude/context/ 2>/dev/null`
- 如果目录不存在或为空：
  - 告诉用户："❌ 未找到上下文。请先运行 /dd:context-create 建立项目上下文。"
  - 优雅退出
- 统计可用上下文文件：`ls -1 .claude/context/*.md 2>/dev/null | wc -l`
- 报告："📁 发现 {count} 个上下文文件需要加载"

### 2. 文件完整性检查
- 对发现的每个上下文文件：
  - 验证文件可读：`test -r ".claude/context/{file}" && echo "可读"`
  - 检查文件有内容：`test -s ".claude/context/{file}" && echo "有内容"`
  - 检查有效前置元数据（应以 `---` 开头）
- 报告任何问题：
  - 空文件："⚠️ {filename} 为空（跳过）"
  - 不可读文件："⚠️ 无法读取 {filename}（权限问题）"
  - 缺失前置元数据："⚠️ {filename} 缺少前置元数据（可能已损坏）"

### 3. 项目状态检查
- 运行：`git status --short 2>/dev/null` 查看当前状态
- 运行：`git branch --show-current 2>/dev/null` 获取当前分支
- 注意是否不在 git 仓库中（上下文可能不够完整）

## 操作指南

### 1. 上下文加载序列

按优先级顺序加载上下文文件以获得最佳理解：

**优先级1 - 核心上下文（首先加载）：**
1. `project-overview.md` - 项目的高层次理解
2. `project-brief.md` - 核心目的和目标
3. `tech-context.md` - 技术栈和依赖

**优先级2 - 当前状态（其次加载）：**
4. `progress.md` - 当前状态和最近工作
5. `project-structure.md` - 目录和文件组织

**优先级3 - 深度上下文（最后加载）：**
6. `system-patterns.md` - 架构和设计模式
7. `product-context.md` - 用户需求和要求
8. `project-style-guide.md` - 编码惯例
9. `project-vision.md` - 长期方向

### 2. 加载过程中的验证

加载每个文件时：
- 检查前置元数据存在并解析：
  - `创建时间` 日期应有效
  - `最后更新` 应 ≥ 创建日期
  - `版本` 应存在
- 如果前置元数据无效，注意但继续加载内容
- 跟踪哪些文件成功加载与失败

### 3. 补充信息

加载上下文文件后：
- 运行：`git ls-files --others --exclude-standard | head -20` 查看未跟踪文件
- 如果存在则读取 `README.md` 获取额外项目信息
- 检查 `.env.example` 或类似文件了解环境设置需求

### 4. 使用智能体进行复杂上下文分析

如果上下文文件较多（>6个）或项目复杂，使用 Task 工具进行深度分析：

```yaml
Task:
  description: "综合分析项目上下文"
  subagent_type: "file-analyzer"
  prompt: |
    分析加载的项目上下文文件，提供项目的综合理解：
    
    已加载的上下文文件：
    {列出所有成功加载的文件}
    
    当前git状态：
    {当前分支和状态信息}
    
    请提供：
    1. 项目的本质和主要目的
    2. 当前开发状态和优先级
    3. 关键技术决策和架构
    4. 需要注意的重要约束或模式
    5. 建议的下一步行动
    
    输出应该简洁但全面，专注于开发工作最相关的信息。
```

### 5. 错误恢复

**如果关键文件缺失：**
- `project-overview.md` 缺失：尝试从 README.md 理解
- `tech-context.md` 缺失：直接分析 package.json/requirements.txt
- `progress.md` 缺失：检查最近 git 提交获取状态

**如果上下文不完整：**
- 通知用户缺失哪些文件
- 建议运行 `/dd:context-update` 刷新上下文
- 使用部分上下文继续但注意限制

### 6. 加载摘要

加载后提供全面摘要：

```markdown
🧠 上下文加载成功

📖 已加载上下文文件：
  ✅ 核心上下文：{count}/3 个文件
  ✅ 当前状态：{count}/2 个文件
  ✅ 深度上下文：{count}/4 个文件

🔍 项目理解：
  - 名称：{project_name}
  - 类型：{project_type}
  - 语言：{primary_language}
  - 状态：{来自 progress.md 的当前状态}
  - 分支：{git_branch}

📊 关键指标：
  - 最后更新：{most_recent_update}
  - 上下文版本：{version}
  - 加载文件：{success_count}/{total_count}

⚠️ 警告：
  {列出任何缺失文件或问题}

🎯 就绪状态：
  ✅ 项目上下文已加载
  ✅ 当前状态已理解
  ✅ 准备进行开发工作

💡 项目摘要：
  {项目内容和当前状态的2-3句总结}

🚀 建议行动：
  - 根据当前进度的下一步建议
  - 需要关注的关键优先级
  - 可能有用的相关命令
```

### 7. 部分上下文处理

如果某些文件无法加载：
- 继续使用可用上下文
- 清楚说明缺失内容
- 建议修复：
  - "缺失技术上下文 - 运行 /dd:context-create 重建"
  - "进度文件损坏 - 运行 /dd:context-update 刷新"

### 8. 性能优化

对于大型上下文：
- 可能时并行加载文件
- 显示进度指示器："加载上下文文件... {current}/{total}"
- 跳过极大文件（>10000行）并警告
- 缓存解析的前置元数据以便更快的后续加载

### 9. 智能上下文应用

加载完成后：
- 根据项目类型和当前状态调整建议
- 识别紧急需要关注的问题
- 提供与当前开发阶段相关的指导
- 建议可能有用的 dd 命令

## 上下文文件处理

### 标准前置元数据格式
```yaml
---
创建时间: 2024-01-01T00:00:00Z
最后更新: 2024-01-01T00:00:00Z
版本: 1.0
作者: DD 工作流系统
---
```

### 内容解析策略
- 优先读取摘要和关键部分
- 识别最近的变更和更新
- 提取可操作的信息和建议
- 理解项目的当前焦点和优先级

## 重要说明

- **始终验证** 文件在尝试读取前
- **按优先级顺序加载** 以首先获取核心上下文
- **优雅处理缺失文件** - 不要完全失败
- **提供清晰摘要** 加载内容和项目状态
- **注意任何问题** 可能影响开发工作

## 安全约束

- 遵循 `.claude/rules/git-safety.md` 中的所有安全规则
- 只执行只读操作收集补充信息
- 不修改任何上下文文件或项目文件
- 仅读取和分析现有上下文内容