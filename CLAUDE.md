# CLAUDE.md

此文件为在本代码库中工作的 Claude Code (claude.ai/code) 提供指导。

## 概览

这是 **DD（开发工作流）系统** - 一个全面的 Claude AI 配置框架，提供结构化的、以安全为重点的开发工作流。该系统实现了从需求分析到任务执行的完整产品开发管道，同时维持严格的安全边界。

## 架构

### 安全优先设计
系统围绕**绝对安全规则**构建，具有多层保护：
- **Git 安全**: 完全禁止 AI 执行任何 git 写操作（add、commit、push、merge 等）
- **文件边界**: AI 只能在 `.claude/` 目录内修改文件，除非明确授权
- **用户控制**: AI 只提供分析和建议 - 用户保持完整的代码库控制权
- **敏感数据保护**: 严格禁止暴露或处理凭证、密钥或敏感信息

### 基于智能体的架构
系统使用专门的子智能体进行上下文优化：
- **代码分析智能体**: 深度代码分析、逻辑跟踪、漏洞检测
- **文件分析智能体**: 文档解析、日志分析、文件摘要
- **测试执行智能体**: 测试运行和全面结果分析
- **上下文分析智能体**: 项目上下文管理和文档记录
- **UI分析智能体**: UI设计图片智能识别、组件分析、代码生成建议

## 核心工作流

### DD 命令系统
所有工作流命令使用 `/dd:` 前缀，共21个命令覆盖完整开发生命周期：

**帮助和状态类（3个）**
- `/dd:help` - 显示完整帮助和使用指南
- `/dd:status` - 项目整体状态、统计和健康度评估  
- `/dd:code-review` - 改动检查和安全审查（只读分析）

**PRD 管理类（4个）**
- `/dd:prd-new <功能名称>` - 创建新的产品需求文档
- `/dd:prd-list [选项]` - 列出所有PRD，支持状态筛选
- `/dd:prd-show <功能名称>` - 查看指定PRD详细内容
- `/dd:prd-parse <功能名称>` - 将PRD转换为技术实施计划（Epic）

**Epic 管理类（3个）**
- `/dd:epic-list [选项]` - 显示所有技术实施计划和进度
- `/dd:epic-show <功能名称>` - 查看Epic详情和技术方案
- `/dd:epic-decompose <功能名称>` - 将Epic分解为具体任务（≤10个）

**任务管理类（7个）**
- `/dd:task-list [选项]` - 显示任务列表，支持筛选和依赖视图
- `/dd:task-show <任务ID>` - 查看任务详情和状态信息
- `/dd:task-start <任务ID>` - 开始执行任务，建立执行上下文
- `/dd:task-pause <任务ID>` - 暂停任务，保存执行状态
- `/dd:task-resume [任务ID]` - 继续执行未完成任务
- `/dd:task-finish <任务ID>` - 完成任务，进行验收检查
- `/dd:task-set <任务ID> <操作> [参数]` - 管理任务属性和依赖

**上下文管理类（3个）**
- `/dd:ctx-init` - 创建项目上下文，生成9个基础文档
- `/dd:ctx-load` - 新会话中加载项目上下文
- `/dd:ctx-sync` - 更新项目上下文，反映最新变化

**代码质量类（1个）**
- `/dd:code-reflect [--详细]` - 改动后自我反思，评估合理性

### 典型工作流程
```bash
# 完整开发流程
/dd:ctx-init                    # 1. 初始化项目上下文
/dd:prd-new 用户认证系统         # 2. 创建需求文档
/dd:prd-parse 用户认证系统       # 3. 转换为技术方案
/dd:epic-decompose 用户认证系统  # 4. 分解为具体任务
/dd:task-list --assignable      # 5. 查看可执行任务
/dd:task-start 001              # 6. 开始执行任务
/dd:task-finish 001             # 7. 完成任务
/dd:code-reflect                # 8. 反思和检查
/dd:ctx-sync                    # 9. 同步上下文
```

### 安全工作流
每个操作都遵循严格的安全验证：
1. 执行前的规则合规性验证
2. 基于命令配置的工具使用限制（YAML 前置说明）
3. 任何规则违反时立即停止并通知用户
4. 复杂分析委托给子智能体以保护主对话上下文

## 文件组织

```
.claude/
├── commands/dd/          # 21+ DD 工作流命令定义
├── agents/              # 专门的 AI 智能体配置
├── rules/              # 多级安全和操作规则
├── prds/               # 产品需求文档
├── epics/              # 技术执行计划和任务
├── context/            # 项目上下文和状态管理
├── designs/            # UI 设计图片和相关资源
└── scripts/            # 实用工具脚本
```

## 关键开发原则

### 绝对规则（不可协商）
- **禁止部分实现**: 只允许完整功能，不允许 TODO 注释
- **禁止代码重复**: 强制重用现有函数和常量
- **禁止死代码**: 代码必须被积极使用或完全删除
- **全面测试**: 每个函数都需要为调试设计的测试
- **一致命名**: 遵循现有代码库模式

### 错误处理理念
- **快速失败**: 关键配置错误导致立即失败
- **优雅降级**: 可选功能记录警告并继续
- **用户友好消息**: 技术错误转换为可操作的指导

### 测试策略
- **无模拟**: 测试使用真实服务和依赖项
- **顺序执行**: 完成当前测试后再开始下一个
- **详细输出**: 测试设计用于全面调试
- **智能体管理**: 始终使用测试执行智能体运行测试

## 重要注意事项

### Git 操作
**AI 完全禁止执行:**
- 任何 git 写操作（add、commit、push、pull、merge、rebase）
- 创建或修改 GitHub 问题/拉取请求
- 任何改变版本控制状态的操作

**AI 只能执行只读 git 操作:**
- `git status`、`git diff`、`git log`、`git show`、`git branch -a`、`git remote -v`

### 智能体使用要求
- **文件分析**: 当被要求读取文件时，始终使用文件分析智能体
- **代码分析**: 对于代码搜索、漏洞研究、逻辑跟踪，始终使用代码分析智能体
- **测试执行**: 运行测试时始终使用测试执行智能体
- **上下文管理**: 项目上下文操作使用上下文分析智能体
- **UI图片识别**: 当执行UI任务时，自动使用UI分析智能体识别和分析设计图片

### 文件修改规则
- AI 只能在 `.claude/` 目录内创建/修改文件
- 源代码修改需要明确的用户授权
- 始终优先编辑现有文件而不是创建新文件
- 除非明确要求，否则永远不要主动创建文档文件

## 配置管理

系统使用基于前置说明的配置，通过 YAML 元数据指定每个命令的工具限制。所有文档都需要 ISO 8601 UTC 时间戳。规则层次结构跨越 5 个级别，从绝对安全要求到行为指导原则。

该框架专为需要企业级安全控制的团队设计，同时利用 AI 辅助进行系统化开发工作流。