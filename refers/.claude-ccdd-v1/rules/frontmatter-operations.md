# 前置元数据操作规则

用于处理 Markdown 文件前置元数据的标准模式和操作。

## 前置元数据格式

所有 dd 系统文件必须使用 YAML 前置元数据：

```yaml
---
名称: 功能名称
描述: 简短描述
状态: backlog|进行中|已完成|已关闭
创建时间: 2024-01-01T00:00:00Z
更新时间: 2024-01-01T00:00:00Z
---
```

## 标准字段定义

### 必填字段
- `名称` - 功能/任务的标识名称（kebab-case 格式）
- `状态` - 当前状态，必须是预定义值之一
- `创建时间` - ISO 8601 格式的 UTC 时间戳

### 可选字段
- `描述` - 简短的功能描述
- `更新时间` - 最后修改时间
- `优先级` - 高|中|低
- `标签` - 分类标签数组
- `依赖` - 依赖的其他任务列表

## 状态管理

### PRD 状态流转
```
backlog -> 评估中 -> 已批准 -> 已实施
```

### Epic 状态流转
```
backlog -> 规划中 -> 进行中 -> 测试中 -> 已完成
```

### 任务状态流转
```
待开始 -> 进行中 -> 待审查 -> 已完成
```

## 操作模式

### 读取前置元数据
```bash
# 提取特定字段
grep '^名称:' 文件名.md | sed 's/^名称: *//'

# 获取状态
grep '^状态:' 文件名.md | sed 's/^状态: *//'
```

### 更新前置元数据
```bash
# 更新状态字段
sed -i.bak "s/^状态:.*/状态: 新状态/" 文件名.md

# 更新时间戳
current_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
sed -i.bak "s/^更新时间:.*/更新时间: $current_date/" 文件名.md
```

### 验证前置元数据
```bash
# 检查必填字段
if ! grep -q '^名称:' 文件名.md; then
  echo "❌ 缺少必填字段：名称"
fi

if ! grep -q '^状态:' 文件名.md; then
  echo "❌ 缺少必填字段：状态"  
fi
```

## 时间戳操作

### 获取当前时间
```bash
# 使用 ISO 8601 格式
date -u +"%Y-%m-%dT%H:%M:%SZ"
```

### 时间戳验证
```bash
# 验证时间格式
if [[ $timestamp =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$ ]]; then
  echo "✅ 时间格式正确"
else
  echo "❌ 时间格式错误"
fi
```

## 批量操作

### 批量状态更新
```bash
# 更新目录下所有文件的状态
for file in *.md; do
  sed -i.bak "s/^状态: 进行中/状态: 已完成/" "$file"
  rm "${file}.bak"
done
```

### 批量添加时间戳
```bash
current_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
for file in *.md; do
  if ! grep -q '^更新时间:' "$file"; then
    sed -i.bak "/^创建时间:/a\\
更新时间: $current_date" "$file"
    rm "${file}.bak"
  fi
done
```

## 错误处理

### 常见错误
- 前置元数据格式错误
- 缺少必填字段
- 时间格式不正确
- 状态值不在预定义范围内

### 修复策略
- 自动添加缺少的必填字段
- 标准化时间格式
- 验证和纠正状态值
- 备份文件以防数据丢失

## 最佳实践

1. **始终备份** - 修改前创建 .bak 文件
2. **验证输入** - 检查所有字段值的有效性
3. **保持一致** - 使用标准的字段名和格式
4. **记录变更** - 更新时间戳记录修改历史
5. **批量验证** - 定期检查所有文件的元数据完整性